<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCU Bestellsystem</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="SCU Logo">
            <h1>SCU Bestellsystem</h1>
        </div>
        
        <div id="waiter-input" class="waiter-section">
            <h2>Kellner Name:</h2>
            <input type="text" id="waiter-name" placeholder="Ihr Name" maxlength="50">
            <button id="set-waiter-name">Best√§tigen</button>
        </div>
        
        <div id="waiter-display" class="waiter-section" style="display: none;">
            <h2>Kellner: <span id="waiter-name-display"></span></h2>
        </div>
        
        <div class="table-selection">
            <h2>Tischnummer:</h2>
            <input type="number" id="table-number" placeholder="z.B. 15" min="1">
        </div>
        
        <div id="menu-container">
            <!-- Men√º wird hier dynamisch eingef√ºgt -->
        </div>
        
        <div class="current-order">
            <h2>Aktuelle Bestellung</h2>
            <ul id="current-order-items"></ul>
            <div class="total" id="current-total">Gesamt: 0.00 ‚Ç¨</div>
            <button id="submit-order">Bestellung abschicken</button>
        </div>
        
        <!-- Debug-Informationen -->
        <div id="debug-info" style="margin-top: 20px; padding: 10px; background-color: #f0f0f0; border-radius: 5px; font-size: 12px;">
            <h3>Debug-Informationen:</h3>
            <div id="connection-status">Verbindung: Wird gepr√ºft...</div>
            <div id="menu-status">Men√º: Wird geladen...</div>
            <div id="socket-status">Socket.IO: Wird verbunden...</div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            let currentOrder = [];
            let waiterName = '';

            const menuContainer = document.getElementById('menu-container');
            const orderItemsList = document.getElementById('current-order-items');
            const totalDisplay = document.getElementById('current-total');
            const submitButton = document.getElementById('submit-order');
            const tableNumberInput = document.getElementById('table-number');
            const waiterInputSection = document.getElementById('waiter-input');
            const waiterDisplaySection = document.getElementById('waiter-display');
            const waiterNameInput = document.getElementById('waiter-name');
            const waiterNameDisplay = document.getElementById('waiter-name-display');
            const setWaiterNameButton = document.getElementById('set-waiter-name');

            // Debug-Elemente
            const connectionStatus = document.getElementById('connection-status');
            const menuStatus = document.getElementById('menu-status');
            const socketStatus = document.getElementById('socket-status');

            // Socket.IO Verbindungsstatus
            socket.on('connect', () => {
                console.log('‚úÖ Socket.IO verbunden:', socket.id);
                socketStatus.textContent = `Socket.IO: Verbunden (${socket.id})`;
                socketStatus.style.color = 'green';
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Socket.IO getrennt');
                socketStatus.textContent = 'Socket.IO: Getrennt';
                socketStatus.style.color = 'red';
            });

            socket.on('connect_error', (error) => {
                console.error('‚ùå Socket.IO Verbindungsfehler:', error);
                socketStatus.textContent = `Socket.IO: Fehler - ${error.message}`;
                socketStatus.style.color = 'red';
            });

            // Kellner Name setzen
            setWaiterNameButton.addEventListener('click', () => {
                const name = waiterNameInput.value.trim();
                if (name) {
                    waiterName = name;
                    waiterNameDisplay.textContent = name;
                    waiterInputSection.style.display = 'none';
                    waiterDisplaySection.style.display = 'block';
                } else {
                    alert('Bitte geben Sie Ihren Namen ein!');
                }
            });

            // Men√º laden
            fetch('/api/menu')
                .then(response => {
                    console.log('üìã Men√º-Response:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(menu => {
                    console.log('‚úÖ Men√º geladen:', menu);
                    menuStatus.textContent = 'Men√º: Geladen';
                    menuStatus.style.color = 'green';
                    displayMenu(menu);
                })
                .catch(error => {
                    console.error('‚ùå Men√º-Fehler:', error);
                    menuStatus.textContent = `Men√º: Fehler - ${error.message}`;
                    menuStatus.style.color = 'red';
                });

            function displayMenu(menu) {
                menuContainer.innerHTML = ''; // Container leeren
                for (const category in menu) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'menu-category';
                    const categoryTitle = category === 'sonntagsgerichte' ? 'Nur Sonntag' : 'Speisen';
                    categoryDiv.innerHTML = `<h2>${categoryTitle}</h2>`;
                    
                    const itemsDiv = document.createElement('div');
                    itemsDiv.className = 'menu-items';

                    menu[category].forEach(item => {
                        const button = document.createElement('button');
                        button.className = 'menu-item';
                        button.textContent = `${item.name} (${item.price.toFixed(2)} ‚Ç¨)`;
                        button.onclick = () => addToOrder(item);
                        itemsDiv.appendChild(button);
                    });
                    categoryDiv.appendChild(itemsDiv);
                    menuContainer.appendChild(categoryDiv);
                }
            }

            function addToOrder(item) {
                currentOrder.push(item);
                updateOrderDisplay();
            }

            function removeFromOrder(itemId) {
                const index = currentOrder.findIndex(item => item.id === itemId);
                if (index > -1) {
                    currentOrder.splice(index, 1);
                    updateOrderDisplay();
                }
            }

            function updateOrderDisplay() {
                orderItemsList.innerHTML = '';
                let total = 0;
                
                const itemCounts = {};
                currentOrder.forEach(item => {
                    itemCounts[item.id] = (itemCounts[item.id] || 0) + 1;
                });

                currentOrder.filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i).forEach(item => {
                    const li = document.createElement('li');
                    const count = itemCounts[item.id];
                    const itemTotal = (item.price * count).toFixed(2);
                    
                    li.innerHTML = `
                        <span>${count}x ${item.name} - ${itemTotal} ‚Ç¨</span>
                        <button class="remove-item" onclick="removeFromOrder(${item.id})">-</button>
                    `;
                    orderItemsList.appendChild(li);
                });

                total = currentOrder.reduce((sum, item) => sum + item.price, 0);
                totalDisplay.textContent = `Gesamt: ${total.toFixed(2)} ‚Ç¨`;
            }

            // Globale Funktion f√ºr removeFromOrder (wird von onclick aufgerufen)
            window.removeFromOrder = removeFromOrder;

            submitButton.addEventListener('click', () => {
                if (!waiterName) {
                    alert('Bitte geben Sie zuerst Ihren Namen ein!');
                    return;
                }
                
                const tableNumber = tableNumberInput.value;
                if (!tableNumber) {
                    alert('Bitte eine Tischnummer eingeben!');
                    return;
                }
                if (currentOrder.length === 0) {
                    alert('Keine Artikel in der Bestellung!');
                    return;
                }

                const total = currentOrder.reduce((sum, item) => sum + item.price, 0);
                const timestamp = new Date().toLocaleString('de-DE');

                console.log('üì§ Bestellung senden:', {
                    table: tableNumber,
                    items: currentOrder,
                    total: total,
                    waiter: waiterName,
                    timestamp: timestamp
                });

                socket.emit('placeOrder', {
                    table: tableNumber,
                    items: currentOrder,
                    total: total,
                    waiter: waiterName,
                    timestamp: timestamp
                });

                alert(`Bestellung f√ºr Tisch ${tableNumber} wurde abgeschickt!`);
                currentOrder = [];
                tableNumberInput.value = '';
                updateOrderDisplay();
            });

            // Initiale Bestellungen laden
            socket.on('initialOrders', (orders) => {
                console.log('üì• Initiale Bestellungen:', orders);
                connectionStatus.textContent = `Verbindung: ${orders.length} Bestellungen geladen`;
                connectionStatus.style.color = 'green';
            });

            // Neue Bestellungen empfangen
            socket.on('newOrder', (order) => {
                console.log('üì• Neue Bestellung empfangen:', order);
            });
        });
    </script>
</body>
</html>